# خطة تنفيذ مرحلية (Phased Plan) لنظام إدارة العيادة

> هذه الخطة تقسم التنفيذ إلى مراحل واضحة، مع أهداف، نطاق، عناصر قابلة للتسليم، تغييرات قاعدة البيانات، الواجهات المتأثرة، معايير القبول، واختبارات لكل مرحلة.

## المرحلة 0: التأسيس والبنية الأساسية
- الهدف: إعداد بيئة العمل الأساسية، الإعدادات، الهيكل، معايير الجودة.
- النطاق:
  - تهيئة مشروع NestJS، ConfigModule، Mongoose، Cache/Redis، I18n، هيكل المجلدات.
  - ضبط ESLint/Prettier/Husky، سكربتات npm.
  - Docker Compose (api + mongo + redis + mailhog dev).
- القابل للتسليم:
  - مشروع يعمل محلياً `npm run start:dev` و`docker compose up`.
  - ملفات .env.example، README محدث.
- قاعدة البيانات/فهارس: لا شيء جوهري.
- معايير القبول: خدمة صحة `GET /health` تُرجع OK.
- اختبارات: تشغيل smoke test للاتصال بمونجو.

## المرحلة 1: الهوية والمستخدمون (Auth/Users)
- الهدف: تسجيل/دخول للمريض، إنشاء أدمن افتراضي، إطار JWT.
- النطاق:
  - نماذج User/PatientProfile.
  - تسجيل مريض، دخول موحّد، Refresh Tokens، سياسات كلمات المرور.
- القابل للتسليم:
  - POST /v1/auth/register/patient
  - POST /v1/auth/login
- قاعدة البيانات/فهارس:
  - users.email فريد، users.phone فريد، patientProfiles.userId فريد.
- معايير القبول: تدفق تسجيل/دخول ناجح مع منع تكرار الإيميل/الهاتف.
- اختبارات: وحدة + E2E لتسجيل/دخول.

## المرحلة 2: الكتالوج (الأقسام والخدمات) + إدارة الأدمن الأساسية
- الهدف: إدارة الأقسام والخدمات، أساس لوحة الإدارة.
- النطاق:
  - Department, Service CRUD للأدمن.
  - ربط الخدمة بالقسم.
- القابل للتسليم:
  - CRUD: /v1/admin/departments, /v1/admin/services
- قاعدة البيانات/فهارس: فهارس departmentId في الخدمات.
- معايير القبول: إنشاء/تحديث/حذف أقسام وخدمات بنجاح، صلاحيات أدمن فقط.
- اختبارات: CRUD + صلاحيات.

## المرحلة 3: ملف الطبيب واعتماد الحساب
- الهدف: تمكين الأدمن من إنشاء طبيب، وتمكين الطبيب من تعديل ملفه.
- النطاق:
  - DoctorProfile (name, license, years, departmentId, photos, bio, status).
  - مسارات: إنشاء طبيب للأدمن، اعتماد/تعليق، تعديل الطبيب لملفه وخدماته وأسعاره.
- القابل للتسليم:
  - POST /v1/admin/doctors
  - PATCH /v1/admin/doctors/:id/status
  - GET/PATCH /v1/doctor/me
- قاعدة البيانات/فهارس: doctorProfiles.userId فريد، فهارس departmentId.
- معايير القبول: لا يمكن للطبيب الدخول كـ DOCTOR إلا بعد الموافقة.
- اختبارات: إنشاء/اعتماد طبيب، تحديث ملف وخدمات.

## المرحلة 4: الجدولة والAvailability للطبيب
- الهدف: تعريف جداول الطبيب وتوليد الفتحات المتاحة.
- النطاق:
  - DoctorSchedule: weeklyTemplate, exceptions, holidays, buffers.
  - API لاسترجاع التوفر حسب الخدمة والأسبوع.
- القابل للتسليم:
  - CRUD /v1/doctor/schedule
  - GET /v1/patient/doctors/:id/availability?serviceId=&weekStart=
- قاعدة البيانات/فهارس: فهارس doctorId على الجداول.
- معايير القبول: توليد فتحات صحيحة مع مراعاة buffers والعطلات.
- اختبارات: تغطية حالات الاستثناءات والعطلات.

## المرحلة 5: الحجز (Appointments) مع منع التداخل وIdempotency وHold
- الهدف: تمكين المريض من الحجز بأمان ومنع التداخل لنفس الطبيب.
- النطاق:
  - إنشاء Appointment بحالة PENDING_CONFIRM، holdExpiresAt (TTL)، قفل Redis عند الإنشاء.
  - Header Idempotency-Key لمنع التكرار.
- القابل للتسليم:
  - POST /v1/patient/appointments
  - POST /v1/patient/appointments/:id/cancel (≤ 24h)
  - POST /v1/patient/appointments/:id/reschedule (>24h)
- قاعدة البيانات/فهارس:
  - appointments: فريد جزئي (doctorId, startAt) للحالات النشطة.
  - TTL على holdExpiresAt.
- معايير القبول: منع حجزين متداخلين لنفس الطبيب، السماح لوقت نفسه مع طبيب آخر.
- اختبارات: تعارض متزامن، انتهاء Hold.

## المرحلة 6: بوابة الدفع (Stub) وتكامل الدفع الأولي
- الهدف: تحضير مسارات الدفع لأنواع VIDEO/CHAT (تُطلب دفعاً).
- النطاق:
  - Payment entity، إنشاء intent وهمي، webhook placeholder.
- القابل للتسليم:
  - POST /v1/payments/intent {appointmentId}
  - POST /v1/payments/webhook
- قاعدة البيانات/فهارس: فهارس appointmentId.
- معايير القبول: لا انتقال إلى CONFIRMED قبل الدفع + تأكيد الطبيب.
- اختبارات: سلوك REQUIRES_PAYMENT.

## المرحلة 7: تأكيد/رفض الطبيب وإدارة الحالة
- الهدف: تمكين الطبيب من تأكيد/رفض المواعيد ضمن جدوله.
- النطاق:
  - تأكيد/رفض، إشعارات TODO، تحديث الحالة.
- القابل للتسليم:
  - POST /v1/doctor/appointments/:id/confirm
  - POST /v1/doctor/appointments/:id/reject
- قاعدة البيانات/فهارس: فهارس doctorId,status.
- معايير القبول: لا يمكن التأكيد إذا أصبحت الفتحة غير متاحة.
- اختبارات: سيناريوهات تأكيد/رفض متعددة.

## المرحلة 8: الجلسات (فيديو Agora + دردشة داخلية) + غرفة انتظار
- الهدف: تمكين جلسات فيديو ودردشة بجودة أساسية.
- النطاق:
  - VideoSession: قناة + توليد توكن عند الطلب، Waiting room.
  - ChatSession + ChatMessage + انتهاء صلاحية حسب الخدمة + أرشفة.
- القابل للتسليم:
  - POST /v1/sessions/video/token {appointmentId, role}
  - GET/POST /v1/sessions/chat/:appointmentId/messages
  - POST /v1/sessions/chat/:appointmentId/archive
- قاعدة البيانات/فهارس: chatMessages(sessionId, createdAt)، فهارس sessions.
- معايير القبول: لا توكن قبل T-10m من الموعد، انتهاء الدردشة عند expiresAt.
- اختبارات: صلاحيات دورية، حدود معدل للرسائل.

## المرحلة 9: السجلات الطبية مع Versioning وAudit
- الهدف: تمكين الطبيب من إنشاء وتحديث السجلات، وتتبع الوصول.
- النطاق:
  - MedicalRecord + MedicalRecordAudit، قوالب تشخيص/روشتة.
- القابل للتسليم:
  - POST /v1/doctor/records
  - PATCH /v1/doctor/records/:id
  - GET /v1/patient/records
- قاعدة البيانات/فهارس: (patientId, updatedAt), (doctorId, updatedAt), audit(recordId, at).
- معايير القبول: المريض يرى فقط سجلاته، تدقيق عرض/تعديل محفوظ.
- اختبارات: صلاحيات الوصول، زيادة version.

## المرحلة 10: لوحة الإدارة والتشغيل
- الهدف: لوحة تشغيل، إدارة عمليات، استيراد/تصدير، login-as.
- النطاق:
  - مؤشرات: إشغال، حجوزات، إلغاء، No‑Show.
  - Import/Export للأقسام والخدمات، Login-as مع Audit.
- القابل للتسليم:
  - GET /v1/admin/metrics/overview
  - POST /v1/admin/login-as {userId}
  - POST /v1/admin/departments:import | GET :export
  - POST /v1/admin/services:import | GET :export
- قاعدة البيانات/فهارس: تجميعات Aggregations.
- معايير القبول: تقارير يومية صحيحة على نطاق أسبوع.
- اختبارات: أذونات المشرف، تدقيق login-as.

## المرحلة 11: i18n والتوقيت
- الهدف: رسائل عربية أولاً + تخزين UTC وعرض محلي.
- النطاق:
  - ملفات ترجمة، مفاتيح رسائل، تنسيق تواريخ.
- القابل للتسليم: رسائل API عربية، خيار لغة بالهيدر لاحقاً.
- معايير القبول: رسائل أخطاء/نجاح بالعربية.
- اختبارات: ردود i18n.

## المرحلة 12: الإشعارات (TODO) والتذكيرات المجدولة
- الهدف: إطار إشعارات SMS لاحقاً + Jobs للتذكيرات.
- النطاق:
  - Jobs: T-24h وT-1h، تنظيف Holds، إغلاق دردشات منتهية، No‑Show.
- القابل للتسليم: Workers/Crons قيد التشغيل.
- معايير القبول: وظائف تعمل وتكتب سجلات تنفيذ.
- اختبارات: اختبار زمني بمحاكاة.

## المرحلة 13: البذور (Seed) والبيانات الأولية
- الهدف: توفير 11 قسماً وخدمات نموذجية، أدمن افتراضي.
- النطاق: سكربت seed وتشغيله عبر npm.
- معايير القبول: قواعد بيانات مهيأة بعد seed.

## المرحلة 14: الجودة والاختبارات E2E
- الهدف: حزمة اختبارات تغطي التدفقات الحرجة.
- النطاق: وحدات + تكامل + E2E لتسجيل/حجز/تأكيد/جلسات/سجلات.
- معايير القبول: نجاح ≥ 90% من الحالات الحرجة.

## المرحلة 15: المراقبة واللوجز (أساسيات)
- الهدف: Structured logging + Request IDs، Health/Readiness.
- النطاق: وسطيات لوج، معرّفات طلبات، تنسيق موحّد.
- معايير القبول: سجلات مفهومة وقابلة للتتبع.

## المرحلة 16: النشر
- الهدف: تشغيل عبر Docker Compose، بيئة Staging.
- النطاق: ملفات ENV منفصلة، دليل نشر.
- معايير القبول: تشغيل مستقر على الخادم المستهدف.

---

## خارطة طريق مختصرة بالأولوية
1) 0→1→2 أساس المنظومة.
2) 3→4→5 تمكين الحجز الآمن.
3) 6→7 الدفع + تأكيد الطبيب.
4) 8 الجلسات.
5) 9 السجلات.
6) 10 إدارة وتشغيل.
7) 11→12 i18n + وظائف مجدولة.
8) 13→14 Seed + اختبارات.
9) 15→16 مراقبة + نشر.

## تعريفات معايير القبول العامة
- أمن: قيود معدل على login، Hash كلمات المرور، RBAC دقيق.
- زمن: كل الأوقات مخزنة UTC مع تحويل للعرض.
- أداء: فهارس المذكورة مُنشأة، استعلامات رئيسية ≤ 200ms على بيانات نموذجية.
- وثائق: Swagger v1 مفعّل، أمثلة لكل مسار أساسي.

## المخاطر والتخفيف
- سباقات الحجز: قفل Redis + فهرس فريد جزئي.
- انتهاء صلاحية الـ Hold: TTL + Job تنظيف.
- فشل مزود الفيديو/الدفع: Backoff وإعادة محاولة/Outbox (لاحقاً).

## ملاحظات التنفيذ
- الالتزام بتقسيم الفروع Git حسب المرحلة.
- كل مرحلة تنتهي بـ PR موثّق يربط المتطلبات بمعايير القبول.
